var notificationMenu=function(){"use strict";var util={featureDetails:{name:"APEX Notification Menu",scriptVersion:"1.7.0",utilVersion:"1.4",url:"https://github.com/quiccoli",license:"MIT"},escapeHTML:function(str){if(null===str)return null;if(void 0!==str){if("object"==typeof str)try{str=JSON.stringify(str)}catch(e){}return apex.util.escapeHTML(String(str))}},jsonSaveExtend:function(srcConfig,targetConfig){var finalConfig={},tmpJSON={};if("string"==typeof targetConfig)try{tmpJSON=JSON.parse(targetConfig)}catch(e){apex.debug.error({module:"util.js",msg:"Error while try to parse targetConfig. Please check your Config JSON. Standard Config will be used.",err:e,targetConfig:targetConfig})}else tmpJSON=$.extend(!0,{},targetConfig);try{finalConfig=$.extend(!0,{},srcConfig,tmpJSON)}catch(e){finalConfig=$.extend(!0,{},srcConfig),apex.debug.error({module:"util.js",msg:"Error while try to merge 2 JSONs into standard JSON if any attribute is missing. Please check your Config JSON. Standard Config will be used.",err:e,finalConfig:finalConfig})}return finalConfig},link:function(link,tabbed){if(!tabbed)return window.parent.location.href=link;window.open(link,"_blank")},cutString:function(text,textLength){try{return textLength<0?text:text.length>textLength?text.substring(0,textLength-3)+"...":text}catch(e){return text}},removeHTML:function(pHTML){return apex&&apex.util&&apex.util.stripHTML?apex.util.stripHTML(pHTML):$("<div/>").html(pHTML).text()}};return{initialize:function(elementID,ajaxID,udConfigJSON,items2Submit,escapeRequired,sanitize,sanitizerOptions){var timers;apex.debug.info({fct:util.featureDetails.name+" - initialize",arguments:{elementID:elementID,ajaxID:ajaxID,udConfigJSON:udConfigJSON,items2Submit:items2Submit,escapeRequired:escapeRequired,sanitize:sanitize,sanitizerOptions:sanitizerOptions},featureDetails:util.featureDetails});var errCount=0,stdConfigJSON={refresh:0,mainIcon:"fa-bell",mainIconColor:"white",mainIconBackgroundColor:"rgba(70,70,70,0.9)",mainIconBlinking:!1,counterBackgroundColor:"rgb(232, 55, 55 )",counterFontColor:"white",linkTargetBlank:!1,showAlways:!1,browserNotifications:{enabled:!0,cutBodyTextAfter:100,link:!1},accept:{color:"#44e55c",icon:"fa-check"},decline:{color:"#b73a21",icon:"fa-close"},hideOnRefresh:!0},sanitizeConfigJSON,stdSanatizerConfigJSON={ALLOWED_ATTR:["accesskey","align","alt","always","autocomplete","autoplay","border","cellpadding","cellspacing","charset","class","colspan","dir","height","href","id","lang","name","rel","required","rowspan","src","style","summary","tabindex","target","title","type","value","width"],ALLOWED_TAGS:["a","address","b","blockquote","br","caption","code","dd","div","dl","dt","em","figcaption","figure","h1","h2","h3","h4","h5","h6","hr","i","img","label","li","nl","ol","p","pre","s","span","strike","strong","sub","sup","table","tbody","td","th","thead","tr","u","ul"]};!1!==sanitize&&(sanitizeConfigJSON=sanitizerOptions?util.jsonSaveExtend(stdSanatizerConfigJSON,sanitizerOptions):stdSanatizerConfigJSON);var configJSON={};configJSON=util.jsonSaveExtend(stdConfigJSON,udConfigJSON);var container=drawContainer(elementID);if(configJSON.browserNotifications.enabled)try{"Notification"in window?Notification.requestPermission():apex.debug.error({fct:util.featureDetails.name+" - drawList",msg:"This browser does not support system notifications",err:e,featureDetails:util.featureDetails})}catch(e){apex.debug.error({fct:util.featureDetails.name+" - initialize",msg:"Error while try to get notification permission",err:e,featureDetails:util.featureDetails})}function escapeOrSanitizeHTML(pHTML){return!1!==escapeRequired?util.escapeHTML(pHTML):!1!==sanitize?DOMPurify.sanitize(pHTML,sanitizeConfigJSON):pHTML}function getData(pCallback){apex.server.plugin(ajaxID,{pageItems:items2Submit},{success:function(pData){apex.debug.info({fct:util.featureDetails.name+" - getData",msg:"AJAX data received",pData:pData,featureDetails:util.featureDetails}),errCount=0,pCallback(pData)},error:function(d){if(0===errCount){var dataJSON={row:[{NOTE_ICON:"fa-exclamation-triangle",NOTE_ICON_COLOR:"#FF0000",NOTE_HEADER:d.responseJSON&&d.responseJSON.error?d.responseJSON.error:"Error occured",NOTE_TEXT:null,NOTE_COLOR:"#FF0000"}]};pCallback(dataJSON),apex.debug.error({fct:util.featureDetails.name+" - getData",msg:"AJAX data error",response:d,featureDetails:util.featureDetails})}errCount++},dataType:"json"})}function drawContainer(elementID){var li=$("<li></li>");li.addClass("t-NavigationBar-item");var div=$("<div></div>");return div.attr("id",elementID),div.bind("apexrefresh",(function(){0==container.children("span").length&&getData(refreshBody)})),li.append(div),$(".t-NavigationBar").prepend(li),div}function drawBody(dataJSON){configJSON.counterBackgroundColor=escapeOrSanitizeHTML(configJSON.counterBackgroundColor),configJSON.counterFontColor=escapeOrSanitizeHTML(configJSON.counterFontColor),configJSON.mainIcon=escapeOrSanitizeHTML(configJSON.mainIcon),configJSON.mainIconBackgroundColor=escapeOrSanitizeHTML(configJSON.mainIconBackgroundColor),configJSON.mainIconColor=escapeOrSanitizeHTML(configJSON.mainIconColor);var div=$("<div></div>");div.addClass("toggleNotifications"),div.attr("id",elementID+"_toggleNote");var ul="#"+elementID+"_ul";div.on("touch click",(function(){$(ul).toggleClass("toggleList")})),$(document).on("touch click",(function(e){!div.is(e.target)&&0===div.has(e.target).length&&!$(e.target).parents(ul).length>0&&!1===$(ul).hasClass("toggleList")&&$(ul).toggleClass("toggleList")}));var countDiv=$("<div></div>");countDiv.addClass("count"),div.append(countDiv);var numDiv=$("<div></div>");numDiv.addClass("num"),numDiv.css("background",configJSON.counterBackgroundColor),numDiv.css("color",configJSON.counterFontColor),numDiv.attr("id",elementID+"_numdiv"),numDiv.html(dataJSON.row.length),countDiv.append(numDiv);var bellLabel=$("<label></label>");bellLabel.addClass("show"),bellLabel.css("background",configJSON.mainIconBackgroundColor);var bellI=$("<i></i>");bellI.addClass("fa"),bellI.addClass(configJSON.mainIcon),bellI.css("color",configJSON.mainIconColor),configJSON.mainIconBlinking&&bellI.addClass("fa-blink"),bellLabel.append(bellI),div.append(bellLabel),container.append(div),refreshBody(dataJSON)}function refreshBody(dataJSON){var toggleNote="#"+elementID+"_toggleNote";if($(toggleNote).hide(),dataJSON.row){var numDivID="#"+elementID+"_numdiv",ulID="#"+elementID+"_ul";dataJSON.row.length>0?($(numDivID).css("background",configJSON.counterBackgroundColor),$(toggleNote).show(),$(numDivID).show(),$(numDivID).text(dataJSON.row.length),$(ulID).empty(),drawList($(toggleNote),dataJSON)):(configJSON.showAlways&&($(toggleNote).show(),$(numDivID).hide()),$(ulID).empty())}}function drawList(div,dataJSON){var str="",ul,isRefresh=!1,divTop;if(configJSON.headerTopText){var divTopLeft,divTopRigth;if(configJSON.headerTopText=escapeOrSanitizeHTML(configJSON.headerTopText),configJSON.headerTopLink=escapeOrSanitizeHTML(configJSON.headerTopLink),(divTop=$("<div></div>")).addClass("menu-top"),(divTopLeft=$("<div></div>")).addClass("menu-top-left"),(divTopRigth=$("<div></div>")).addClass("menu-top-right"),configJSON.headerTopLink){var aDiv=$("<a></a>");aDiv.attr("href",configJSON.headerTopLink),aDiv.append(configJSON.headerTopText)}divTopRigth.append(aDiv),divTop.append(divTopLeft),divTop.append(divTopRigth)}$("#"+elementID+"_ul").length?(ul=$("#"+elementID+"_ul"),isRefresh=!0):((ul=$("<ul></ul>")).attr("id",elementID+"_ul"),ul.addClass("notifications"),ul.addClass("toggleList")),isRefresh&&configJSON.hideOnRefresh&&!1===$(ul).hasClass("toggleList")&&$(ul).addClass("toggleList"),ul.append(divTop),dataJSON.row&&$.each(dataJSON.row,(function(item,data){if(configJSON.browserNotifications.enabled&&1!=data.NO_BROWSER_NOTIFICATION)try{var title,text;data.NOTE_HEADER&&(title=util.removeHTML(data.NOTE_HEADER)),data.NOTE_TEXT&&(text=util.removeHTML(data.NOTE_TEXT),text=util.cutString(text,configJSON.browserNotifications.cutBodyTextAfter)),setTimeout((function(){if("Notification"in window)if("granted"===Notification.permission){var notification=new Notification(title,{body:text,requireInteraction:configJSON.browserNotifications.requireInteraction});configJSON.browserNotifications.link&&data.NOTE_LINK&&(notification.onclick=function(event){util.link(data.NOTE_LINK)})}else"denied"!==Notification.permission&&Notification.requestPermission((function(permission){if("granted"===permission){var notification=new Notification(title,{body:text,requireInteraction:configJSON.browserNotifications.requireInteraction});configJSON.browserNotifications.link&&data.NOTE_LINK&&(notification.onclick=function(event){util.link(data.NOTE_LINK)})}}));else apex.debug.error({fct:util.featureDetails.name+" - drawList",msg:"This browser does not support system notifications",featureDetails:util.featureDetails})}),150*item)}catch(e){apex.debug.error({fct:util.featureDetails.name+" - drawList",msg:"Error while try to get notification permission",err:e,featureDetails:util.featureDetails})}data.NOTE_HEADER&&(data.NOTE_HEADER=escapeOrSanitizeHTML(data.NOTE_HEADER)),data.NOTE_ICON&&(data.NOTE_ICON=escapeOrSanitizeHTML(data.NOTE_ICON)),data.NOTE_ICON_COLOR&&(data.NOTE_ICON_COLOR=escapeOrSanitizeHTML(data.NOTE_ICON_COLOR)),data.NOTE_TEXT&&(data.NOTE_TEXT=escapeOrSanitizeHTML(data.NOTE_TEXT)),data.NOTE_DATE&&(data.NOTE_DATE=escapeOrSanitizeHTML(data.NOTE_DATE)),data.ACCEPT_ICON&&(data.ACCEPT_ICON=escapeOrSanitizeHTML(data.ACCEPT_ICON)),data.ACCEPT_ICON_COLOR&&(data.ACCEPT_ICON_COLOR=escapeOrSanitizeHTML(data.ACCEPT_ICON_COLOR)),data.DECLINE_ICON&&(data.DECLINE_ICON=escapeOrSanitizeHTML(data.DECLINE_ICON)),data.DECLINE_ICON_COLOR&&(data.DECLINE_ICON_COLOR=escapeOrSanitizeHTML(data.DECLINE_ICON_COLOR));var a=$("<a></a>");data.NOTE_LINK&&(a.attr("href",data.NOTE_LINK),configJSON.linkTargetBlank&&a.attr("target","_blank"),a.on("touch click",(function(e){$(ul).addClass("toggleList")})));var li=$("<li></li>");if(li.addClass("note"),data.NOTE_COLOR&&li.css("box-shadow","-5px 0 0 0 "+data.NOTE_COLOR),data.NOTE_DATE){var noteDate=$("<div></div>");noteDate.addClass("note-date"),noteDate.append(data.NOTE_DATE),li.append(noteDate)}if(data.NOTE_ACCEPT||data.NOTE_DECLINE){if(li.css("padding-right","32px"),data.NOTE_ACCEPT){var acceptA=$("<a></a>");acceptA.addClass("accept-a"),acceptA.attr("href",data.NOTE_ACCEPT);var acceptI=$("<i></i>");acceptI.addClass("fa"),acceptI.addClass(data.ACCEPT_ICON?data.ACCEPT_ICON:configJSON.accept.icon),acceptI.css("color",data.ACCEPT_ICON_COLOR?data.ACCEPT_ICON_COLOR:configJSON.accept.color),acceptI.css("font-size","20px"),acceptA.append(acceptI),li.append(acceptA)}if(data.NOTE_DECLINE){var declineA=$("<a></a>");declineA.addClass("decline-a"),declineA.attr("href",data.NOTE_DECLINE),data.NOTE_ACCEPT&&declineA.css("bottom","40px");var declineI=$("<i></i>");declineI.addClass("fa"),declineI.addClass(data.DECLINE_ICON?data.DECLINE_ICON:configJSON.decline.icon),declineI.css("color",data.DECLINE_ICON_COLOR?data.DECLINE_ICON_COLOR:configJSON.decline.color),declineI.css("font-size","24px"),declineA.append(declineI),li.append(declineA)}}var noteHeader=$("<div></div>");noteHeader.addClass("note-header");var i=$("<i></i>");i.addClass("fa"),data.NOTE_ICON&&i.addClass(data.NOTE_ICON),data.NOTE_ICON_COLOR&&i.css("color",data.NOTE_ICON_COLOR),i.addClass("fa-lg"),noteHeader.append(i),data.NOTE_HEADER&&noteHeader.append(data.NOTE_HEADER),li.append(noteHeader);var span=$("<span></span>");span.addClass("note-info"),data.NOTE_TEXT&&span.html(data.NOTE_TEXT),li.append(span),a.append(li),ul.append(a)})),$("body").append(ul)}getData(drawBody),configJSON.refresh>0&&(timers=setInterval((function(){0===$("#"+elementID).length&&clearInterval(timers),errCount>=2&&clearInterval(timers),0==container.children("span").length&&(ajaxID?getData(refreshBody):refreshBody(dataJSON))}),1e3*configJSON.refresh))}}}();